<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Zile GUO">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Zile GUO">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zile GUO">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Zile GUO</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zile GUO</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/24/rn-nested-scroll/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zile GUO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zile GUO">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/24/rn-nested-scroll/" class="post-title-link" itemprop="url">RN嵌套滑动</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-09-24 15:16:20 / Modified: 15:17:11" itemprop="dateCreated datePublished" datetime="2021-09-24T15:16:20+08:00">2021-09-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/animation/" itemprop="url" rel="index"><span itemprop="name">animation</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/animation/interaction/" itemprop="url" rel="index"><span itemprop="name">interaction</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在嵌套滑动或其他复杂的交互场景时，我们需要对用户的手势进行识别。判断应该由哪个元素来响应这个手势事件。如在两个嵌套垂直滚动的ScrollView中，我们需要判断用户的意图是作用于内部还是外部的ScrollView。</p>
<h2 id="手势识别能力"><a href="#手势识别能力" class="headerlink" title="手势识别能力"></a>手势识别能力</h2><p>对于滑动手势的识别，有下面三种能力层级：</p>
<ol>
<li>滑动中识别（<em>abbrev</em>. 能力1）</li>
<li>滑动开始时识别（<em>abbrev</em>. 能力2）</li>
<li>通过上一次滑动手势识别（<em>abbrev</em>. 能力3）</li>
</ol>
<p>由上至下，识别延迟增加，用户体验降低。</p>
<h2 id="仅使用react-native"><a href="#仅使用react-native" class="headerlink" title="仅使用react-native"></a>仅使用react-native</h2><h3 id="一个简单的例子"><a href="#一个简单的例子" class="headerlink" title="一个简单的例子"></a>一个简单的例子</h3><h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><p>以下面的<a href="https://youtu.be/V8maYc4R2G0?t=826" target="_blank" rel="noopener">浮层</a>为例。在地图app中，我们需要实现一个纵向滑动的浮层，内部嵌套了一个纵向滑动的地点列表。</p>
<p><img src="https://i.loli.net/2021/09/08/8jlE9BbvVgsUXzR.png" alt="截屏2021-09-08 上午11.34.39"></p>
<p>在结构上，我们可以这样理解上面这个例子：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">App</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Map</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Drawer</span>&gt;</span> // 浮层</span><br><span class="line">    <span class="tag">&lt;<span class="name">Search</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Locations</span> /&gt;</span> // 地点列表</span><br><span class="line">  <span class="tag">&lt;/<span class="name">Drawer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">App</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>设想我们在浮层展开的状态下向下拖动地点列表，对应<code>手势识别能力</code>分别会是如下的交互形式：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>识别能力</th>
<th>交互</th>
<th>拖动次数</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>滑动中识别</td>
<td>用户下拉地点列表到底后，浮层开始下拉</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>滑动开始时识别</td>
<td>用户下拉地点列表到底后，无法继续下拉。再次下拉时浮层下拉</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>通过上一次滑动手势识别</td>
<td>用户下拉地点列表到底后，无法继续下拉。再次下拉无响应。再次下拉时浮层下拉</td>
<td>3</td>
</tr>
</tbody></table>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>对于上面这个简单的例子，我们可以通过一个ScrollView来实现<strong>滑动中识别</strong>的能力：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ScrollView</span> <span class="attr">stickyHeaderIndices</span>=<span class="string">&#123;[1]&#125;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">TransparentPlaceholder</span> /&gt;</span> // 透明占位符</span><br><span class="line">  <span class="tag">&lt;<span class="name">Search</span> /&gt;</span> // 搜索栏</span><br><span class="line">  <span class="tag">&lt;<span class="name">Location-1</span>/&gt;</span> // 地点1</span><br><span class="line">  <span class="tag">&lt;<span class="name">Location-2</span>/&gt;</span> // 地点2</span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过<code>stickyHeaderIndices</code>配置，我们可以实现指定项目的吸顶功能。由于只使用了一个ScrollView，在用户的观感上，地点列表拖动到底之后，浮层就会开始下拉，体验流畅。</p>
<h3 id="更加复杂的例子"><a href="#更加复杂的例子" class="headerlink" title="更加复杂的例子"></a>更加复杂的例子</h3><h4 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h4><p>在下面我的播客浮层中，我们添加了可以横向滚动的tab。这使得在横划过后，内部嵌套的ScrollView存在了不同的垂直滚动状态，因此我们不再能够仅用一个ScrollView来模拟内外两层的垂直滚动。</p>
<p><img src="https://i.loli.net/2021/09/24/CtSqVTBjAibH2rO.png" alt="截屏2021-09-24 下午2.20.51"></p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>这其实是一个响应者（<a href="https://docs.swmansion.com/react-native-gesture-handler/docs/about-handlers" target="_blank" rel="noopener">gesture handler</a>）的问题：当内部ScrollView滚动到底时，根据用户手势的方向，需要判断由内层列表还是外层抽屉对手势进行响应。</p>
<p>对于外层的抽屉，有两种实现方式：</p>
<ol>
<li><p>外层使用PanResponder（优点：更可控的外层浮层动画）</p>
<p>事件拦截：通过<code>onMoveShouldSetPanResponderCapture</code>在需要时拦截用户的拖动事件，阻止内部列表的响应</p>
<p>事件响应：通过<code>onPanResponderMove</code>和<code>onPanResponderRelease</code>对拖动事件进行响应，通过<code>Animated.ValueXY</code>将其绑定到抽屉的transitionY上<br><img src="https://i.loli.net/2021/09/08/SaLKOICMtk7ZeUY.jpg" alt="5e96a0842dcade04fbfbc993a1y9cA7101"></p>
</li>
<li><p>外层使用ScrollView（优点：更好的性能）</p>
<p>事件拦截：通过<code>scrollEnabled</code>属性对事件进行拦截</p>
<p>事件响应：使用<code>nestedScrollEnabled</code>实现嵌套的滚动，利用ScrollView原生的能力直接进行响应</p>
</li>
</ol>
<h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><p>在这个需求中，我们使用了PanResponder的方法进行实现（方案1）。核心的手势响应代码可以参照<code>参考 - 2.usePanResponder</code>。</p>
<p>不管PanResponder（方案1）还是ScrollView（方案2），都无法在滑动过程中切换响应的View，因此只能实现<code>能力2</code>。</p>
<h4 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h4><p>在安卓端使用方案1进行实现时，由于ScrollView存在一些<a href="https://stackoverflow.com/questions/55082289/react-native-propagate-pan-responder-event-from-view-to-inner-scroll-view/55251301#55251301" target="_blank" rel="noopener">奇特的表现</a>，我们需要猜测用户的意图以实现部分操作的<code>能力2</code>，而有些时候，由于猜测不准确，只能实现<code>能力3</code>。</p>
<blockquote>
<p>安卓端ScrollView的奇特表现：当ScrollView开始滑动的时候，<code>onMoveShouldSetPanResponderCapture</code>和<code>onPanResponderMove</code>无法被持续触发。（在测试中通过设置<code>nestedScrollEnabled</code>属性，我们的PanResponder可以拦截到更多事件，但仍然无法达到IOS上的效果）</p>
<p>用户意图的猜测：当用户下拉内部列表到底后，猜测用户下一步会收起浮层，提前锁定内部的<code>ScrollView</code>。</p>
</blockquote>
<h2 id="使用react-native-gesture-handler"><a href="#使用react-native-gesture-handler" class="headerlink" title="使用react-native-gesture-handler"></a>使用react-native-gesture-handler</h2><p>从上一节可以看到，仅使用react-native提供的功能，无法实现能力1的嵌套滑动效果。而react-native-gesture-handler优化了手势响应的机制，使其具备更加复杂的手势识别能力。在<a href="https://github.com/software-mansion/react-native-gesture-handler/issues/420" target="_blank" rel="noopener">github issue的讨论</a>中我们可以看到针对抽屉这个场景，如何选择正确的响应者对手势进行响应。同时库中还提供了一个<a href="https://github.com/software-mansion/react-native-gesture-handler/blob/13053b92ac030e340099cdfee648623408bc8021/examples/Example/src/bottomSheet/index.tsx#L129-L132" target="_blank" rel="noopener">demo</a>，通过代码展示如何实现一个嵌套滚动的抽屉。</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><h4 id="需求-2"><a href="#需求-2" class="headerlink" title="需求"></a>需求</h4><p>以上面这个地图例子为例。设想我们需要实现更加复杂的功能：即无论内部列表滚动到何种状态，向下拉动浮层的上沿（区域1）可以直接收起浮层。当我们还是使用单个ScrollView时，下拉会先造成内部列表下拉，然后再造成浮层下拉。</p>
<p><img src="https://i.loli.net/2021/09/24/PFnmfrNkh3gMEt5.png" alt="8jlE9BbvVgsUXzR"></p>
<h4 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h4><p>针对这类需求，npm上已经有包利用<a href="https://github.com/software-mansion/react-native-gesture-handler/blob/13053b92ac030e340099cdfee648623408bc8021/examples/Example/src/bottomSheet/index.tsx#L129-L132" target="_blank" rel="noopener">demo</a>的原理进行了封装：<a href="https://www.npmjs.com/package/@gorhom/bottom-sheet" target="_blank" rel="noopener">@gorhom/bottom-sheet</a>。通过简单的代码，即可实现能力1的交互形式：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;BottomSheet</span><br><span class="line">  ref=&#123;bottomSheetRef&#125;</span><br><span class="line">  index=&#123;<span class="number">1</span>&#125;</span><br><span class="line">  snapPoints=&#123;SNAP_POINTS&#125;</span><br><span class="line">  onChange=&#123;() =&gt; &#123;&#125;&#125;&gt;</span><br><span class="line">  &lt;View&gt;</span><br><span class="line">    &lt;Search /&gt; <span class="comment">// 搜索栏</span></span><br><span class="line">    &lt;BottomSheetScrollView&gt;</span><br><span class="line">      &lt;Location<span class="number">-1</span>/&gt; <span class="comment">// 地点1</span></span><br><span class="line">  		&lt;Location<span class="number">-2</span>/&gt; <span class="comment">// 地点2</span></span><br><span class="line">      ...</span><br><span class="line">    &lt;<span class="regexp">/BottomSheetScrollView&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>View&gt;</span><br><span class="line">&lt;<span class="regexp">/BottomSheet&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> @gorhom/bottom-sheet内部依赖了react-native-gesture-handler和react-native-reanimated，使用时切忌遗漏安装对应的客户端包</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文描述了嵌套垂直滑动的三种手势识别能力。并针对抽屉组件中嵌套ScrollView的不同需求场景，简述了仅使用RN提供的API &amp; 使用react-native-gesture-handler，实现不同能力的方法。可以看到，react-native-gesture-handler提供了更加完整的基础能力，以实现复杂的手势响应能力；但与此同时也增加了代码的复杂度。</p>
<h2 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h2><p>在我的播客例子中，目前仅使用原生的方法实现了能力2的手势响应机制。通过react-native-gesture-handler，是否能够实现能力1的手势响应机制，以及如何实现，还待研究。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h3 id="1-react-native-gesture-handler"><a href="#1-react-native-gesture-handler" class="headerlink" title="1. react native gesture handler"></a>1. react native gesture handler</h3><p>Document: <a href="https://docs.swmansion.com/react-native-gesture-handler/docs/" target="_blank" rel="noopener">https://docs.swmansion.com/react-native-gesture-handler/docs/</a></p>
<p>Video: <a href="https://www.youtube.com/watch?v=V8maYc4R2G0&amp;ab_channel=ReactConferencesbyGitNation" target="_blank" rel="noopener">https://www.youtube.com/watch?v=V8maYc4R2G0&amp;ab_channel=ReactConferencesbyGitNation</a></p>
<h4 id="RN手势检测的问题"><a href="#RN手势检测的问题" class="headerlink" title="RN手势检测的问题"></a>RN手势检测的问题</h4><ol>
<li>gesture recognition logic is distributed between threads that run in parallel</li>
<li>lack of an API that would allow for defining interactions between native gesture recognizers</li>
<li>touch events recognized by JS responder system cannot be connected with native animated nodes</li>
</ol>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>在UI线程（native）识别多个手势，按需激活正确的单个响应器，并使用Animated Native Driver实现流畅动画</p>
<h3 id="2-usePanResponder"><a href="#2-usePanResponder" class="headerlink" title="2. usePanResponder"></a>2. usePanResponder</h3><p>外层抽屉浮层的pan responder配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    useCallback, useMemo, useRef</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    PanResponder,</span><br><span class="line">    Animated</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'react-native'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    usePropsRef, closerToZero, flag, limitInBetween</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./utils'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stablePositions = &#123;</span><br><span class="line">    TOP: <span class="number">0</span>,</span><br><span class="line">    BOTTOM: <span class="number">1</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">usePanResponder</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> up为y减小，down为y增大</span></span></span><br><span class="line"><span class="function"><span class="params">    lockDown, lockUp,</span></span></span><br><span class="line"><span class="function"><span class="params">    captureUp, captureDown,</span></span></span><br><span class="line"><span class="function"><span class="params">    thresholdUp, thresholdDown, <span class="regexp">//</span> 滑动绝对距离的阈值</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="regexp">//</span> top为y最小值，down为y最大值</span></span></span><br><span class="line"><span class="function"><span class="params">    onTopReached, onBottomReached,</span></span></span><br><span class="line"><span class="function"><span class="params">    topBoundY, bottomBoundY,</span></span></span><br><span class="line"><span class="function"><span class="params">    defaultY, <span class="regexp">//</span> 默认开始位置</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> props = usePropsRef(&#123;</span><br><span class="line">        lockDown,</span><br><span class="line">        lockUp,</span><br><span class="line">        captureUp,</span><br><span class="line">        captureDown,</span><br><span class="line">        thresholdUp,</span><br><span class="line">        thresholdDown,</span><br><span class="line">        onTopReached,</span><br><span class="line">        onBottomReached,</span><br><span class="line">        topBoundY,</span><br><span class="line">        bottomBoundY,</span><br><span class="line">        defaultY</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取手势前的位置</span></span><br><span class="line">    <span class="keyword">const</span> lastStablePosition = useRef(</span><br><span class="line">        <span class="built_in">Math</span>.abs(defaultY - topBoundY) &lt; <span class="built_in">Math</span>.abs(defaultY - bottomBoundY)</span><br><span class="line">            ? stablePositions.TOP : stablePositions.BOTTOM</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> getStablePositionY = useCallback(</span><br><span class="line">        stablePosition =&gt; (</span><br><span class="line">            stablePosition === stablePositions.TOP</span><br><span class="line">                ? props.current.topBoundY : props.current.bottomBoundY</span><br><span class="line">        ), []</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 位置动画</span></span><br><span class="line">    <span class="keyword">const</span> position = useRef(<span class="keyword">new</span> Animated.ValueXY(&#123; <span class="attr">y</span>: defaultY, <span class="attr">x</span>: <span class="number">0</span> &#125;)).current;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 动画position到指定位置</span></span><br><span class="line">    <span class="keyword">const</span> transitionTo = useCallback(<span class="function">(<span class="params">stablePosition</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> isBottom = stablePosition === stablePositions.BOTTOM;</span><br><span class="line">        Animated.spring(</span><br><span class="line">            position,</span><br><span class="line">            &#123; <span class="attr">toValue</span>: isBottom ? props.current.bottomBoundY : props.current.topBoundY &#125;</span><br><span class="line">        ).start(<span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;);</span><br><span class="line"></span><br><span class="line">        lastStablePosition.current = stablePosition;</span><br><span class="line">        <span class="keyword">if</span> (isBottom) props.current.onBottomReached();</span><br><span class="line">        <span class="keyword">else</span> props.current.onTopReached();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 手势监听器</span></span><br><span class="line">    <span class="keyword">const</span> panResponder = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> PanResponder.create(&#123;</span><br><span class="line">        onStartShouldSetPanResponder: <span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">true</span>,</span><br><span class="line">        onMoveShouldSetPanResponderCapture: <span class="function">(<span class="params">evt, gesture</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> verticalCapture = getVerticalPanValue(&#123;</span><br><span class="line">                upValue: props.current.captureUp,</span><br><span class="line">                downValue: props.current.captureDown,</span><br><span class="line">                elseValue: <span class="literal">false</span></span><br><span class="line">            &#125;, gesture);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> verticalCapture;</span><br><span class="line">        &#125;,</span><br><span class="line">        onPanResponderMove: <span class="function">(<span class="params">e, gesture</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> lock = getVerticalPanValue(&#123;</span><br><span class="line">                upValue: props.current.lockUp,</span><br><span class="line">                downValue: props.current.lockDown,</span><br><span class="line">                elseValue: <span class="literal">false</span></span><br><span class="line">            &#125;, gesture);</span><br><span class="line">            <span class="keyword">if</span> (lock) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> targetY = getStablePositionY(lastStablePosition.current) + gesture.dy;</span><br><span class="line">            <span class="keyword">const</span> limitedTargetY = limitInBetween(</span><br><span class="line">                targetY, [props.current.topBoundY, props.current.bottomBoundY]</span><br><span class="line">            );</span><br><span class="line">            <span class="keyword">if</span> (limitedTargetY === targetY) &#123; <span class="comment">// in bound</span></span><br><span class="line">                position.setValue(&#123; <span class="attr">y</span>: targetY &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// over bound (use rubberband)</span></span><br><span class="line">                <span class="keyword">const</span> overDistance = closerToZero(</span><br><span class="line">                    targetY - props.current.topBoundY, targetY - props.current.bottomBoundY</span><br><span class="line">                );</span><br><span class="line">                position.setValue(&#123;</span><br><span class="line">                    y: limitedTargetY + flag(overDistance) * calculateRubberband(</span><br><span class="line">                        <span class="built_in">Math</span>.abs(overDistance)</span><br><span class="line">                    )</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onPanResponderRelease: <span class="function">(<span class="params">e, gesture</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> lock = getVerticalPanValue(&#123;</span><br><span class="line">                upValue: props.current.lockUp,</span><br><span class="line">                downValue: props.current.lockDown,</span><br><span class="line">                elseValue: <span class="literal">false</span></span><br><span class="line">            &#125;, gesture);</span><br><span class="line">            <span class="keyword">if</span> (lock) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> &#123; dy &#125; = gesture;</span><br><span class="line">            <span class="keyword">const</span> absoluteDy = <span class="built_in">Math</span>.abs(dy);</span><br><span class="line">            <span class="keyword">const</span> flagDy = flag(dy);</span><br><span class="line">            <span class="keyword">if</span> (lastStablePosition.current === stablePositions.TOP</span><br><span class="line">                &amp;&amp; absoluteDy &gt; props.current.thresholdDown</span><br><span class="line">                &amp;&amp; flagDy &gt; <span class="number">0</span>) &#123; <span class="comment">// to down</span></span><br><span class="line">                transitionTo(stablePositions.BOTTOM);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastStablePosition.current === stablePositions.BOTTOM</span><br><span class="line">                &amp;&amp; absoluteDy &gt; props.current.thresholdUp</span><br><span class="line">                &amp;&amp; flagDy &lt; <span class="number">0</span>) &#123; <span class="comment">// to up</span></span><br><span class="line">                transitionTo(stablePositions.TOP);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; <span class="comment">// reset position</span></span><br><span class="line">                transitionTo(lastStablePosition.current);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;), [position]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        panResponder,</span><br><span class="line">        position</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateRubberband</span>(<span class="params">overDistance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt(overDistance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getVerticalPanValue</span>(<span class="params">&#123; upValue, downValue, elseValue &#125;, gesture</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; dx, dy &#125; = gesture;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 竖直滑动</span></span><br><span class="line">    <span class="keyword">const</span> panRatio = <span class="built_in">Math</span>.abs(dx / dy);</span><br><span class="line">    <span class="keyword">const</span> verticalDrag = panRatio &lt; <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!verticalDrag) <span class="keyword">return</span> elseValue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dy &lt; <span class="number">0</span>) &#123; <span class="comment">// up</span></span><br><span class="line">        <span class="keyword">return</span> upValue;</span><br><span class="line">    &#125; <span class="keyword">if</span> (dy &gt; <span class="number">0</span>) &#123; <span class="comment">// down</span></span><br><span class="line">        <span class="keyword">return</span> downValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> elseValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/25/lottie-theme-color/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zile GUO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zile GUO">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/25/lottie-theme-color/" class="post-title-link" itemprop="url">React Native 动画应用主题颜色实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-25 15:02:09" itemprop="dateCreated datePublished" datetime="2021-04-25T15:02:09+08:00">2021-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-24 15:06:57" itemprop="dateModified" datetime="2021-09-24T15:06:57+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/lottie/" itemprop="url" rel="index"><span itemprop="name">lottie</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/lottie/react-native/" itemprop="url" rel="index"><span itemprop="name">react native</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>使用lottie创建动画，修改lottie json中对应颜色的属性。</p>
<p>找到颜色属性的方法：让视觉提供两个颜色不同的json文件，作比较。</p>
<p>如需实现类似tintColor一样修改所有颜色的效果，可以使用Reference中的代码。</p>
<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><p><strong>常规格式动画图片（gif, webp, apng）</strong></p>
<ul>
<li>ios：tintColor不会用到所有格式的动画图片（gif, webp, apng）上</li>
<li>安卓：对于asset中的webp图片，tintColor会生效</li>
</ul>
<p><strong>Lottie</strong></p>
<ul>
<li>方案1：使用colorFilter，不生效（不知道是不是配置有错，网上文档较少）</li>
<li>方案2：直接改json，让视觉提供色彩不同的两个json文件，compare后可以知道需要改哪些地方</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>修改lottie中所有颜色的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import &#123; useMemo &#125; from &#39;react&#39;;</span><br><span class="line"></span><br><span class="line">function replaceColor(object, color) &#123;</span><br><span class="line">    if (typeof object !&#x3D;&#x3D; &#39;object&#39;) return; &#x2F;&#x2F; 不是object</span><br><span class="line"></span><br><span class="line">    for (const key of Object.keys(object)) &#123;</span><br><span class="line">        if (key &#x3D;&#x3D;&#x3D; &#39;k&#39; &amp;&amp; object[key].length &#x3D;&#x3D;&#x3D; 4 &amp;&amp; typeof object[key][0] &#x3D;&#x3D;&#x3D; &#39;number&#39;) &#123; &#x2F;&#x2F; 替换颜色</span><br><span class="line">            &#x2F;&#x2F; eslint-disable-next-line no-param-reassign</span><br><span class="line">            object[key] &#x3D; [color[0], color[1], color[2], object[key][3]]; &#x2F;&#x2F; 保留alpha</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            replaceColor(object[key], color);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 将Lottie文件中的所有颜色替换为给定颜色</span><br><span class="line">&#x2F;&#x2F; targetColor格式 rgba(x,x,x,x)</span><br><span class="line">export default function useLottieThemeColor(json, targetColor) &#123;</span><br><span class="line">    return useMemo(() &#x3D;&gt; &#123;</span><br><span class="line">        const res &#x3D; JSON.parse(JSON.stringify(json));</span><br><span class="line"></span><br><span class="line">        let colorVec;</span><br><span class="line">        try &#123;</span><br><span class="line">            colorVec &#x3D; JSON.parse(targetColor.replace(&#x2F;(rgba\()([0-9., ]+)(\))&#x2F;, &#39;[$2]&#39;));</span><br><span class="line">            colorVec &#x3D; colorVec.map((v, index) &#x3D;&gt; &#123;</span><br><span class="line">                if (index &gt;&#x3D; 0 &amp;&amp; index &lt; 3) &#123;</span><br><span class="line">                    return v &#x2F; 255;</span><br><span class="line">                &#125;</span><br><span class="line">                return v;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; catch &#123;</span><br><span class="line">            console.error(&#96;Failed to parse theme color: $&#123;targetColor&#125; to color vector&#96;);</span><br><span class="line">            return res;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        replaceColor(res, colorVec);</span><br><span class="line"></span><br><span class="line">        return res;</span><br><span class="line">    &#125;, []);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/26/log-hoc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zile GUO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zile GUO">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/26/log-hoc/" class="post-title-link" itemprop="url">埋点HOC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-02-26 15:09:46" itemprop="dateCreated datePublished" datetime="2021-02-26T15:09:46+08:00">2021-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-24 15:13:12" itemprop="dateModified" datetime="2021-09-24T15:13:12+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/log/" itemprop="url" rel="index"><span itemprop="name">log</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在react中，对于公共组件，与组件职责无关的埋点参数需要通过props深入传递，影响代码可读性和耦合度。本文介绍了一种通过HOC在祖先组件中添加埋点信息，并在埋点组件中读取的方式。通过独立数据流，提高了代码的可读性，降低耦合度。</p>
<h3 id="问题示例"><a href="#问题示例" class="headerlink" title="问题示例"></a>问题示例</h3><h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><p>两个业务组件：</p>
<ol>
<li>音乐列表组件 - MusicList</li>
<li>音乐列表项组件 - MusicItem</li>
</ol>
<p>有两个业务页面：</p>
<ol>
<li><p>播放列表页面 - PlayListPage</p>
</li>
<li><p>收藏列表页面 - CollectionListPage</p>
</li>
</ol>
<p>组织结构如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">////////// 组件 //////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 音乐列表</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MusicList</span>(<span class="params">&#123;fetchList&#125;</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> [list, setList] = useState([])</span><br><span class="line">	useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">		fetchList.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;setList&#123;res&#125;&#125;)</span><br><span class="line">	&#125;, [])</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> musicItems = list.map(<span class="function"><span class="params">item</span> =&gt;</span> <span class="xml"><span class="tag">&lt;<span class="name">MusicItem</span> <span class="attr">key</span>=<span class="string">&#123;item.id&#125;</span> <span class="attr">item</span>=<span class="string">&#123;item&#125;</span> /&gt;</span></span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;musicItems&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 音乐列表项</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MusicItem</span>(<span class="params">&#123;item&#125;</span>) =&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;item.name&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////////// 页面 //////////</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放列表页面</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">PlayListPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">MusicList</span> <span class="attr">fetchList</span>=<span class="string">&#123;fetchPlayList&#125;</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 收藏列表页面</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CollectionListPage</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">MusicList</span> <span class="attr">fetchList</span>=<span class="string">&#123;fetchCollectionList&#125;</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们需要对以上页面进行埋点，埋点信息格式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 页面曝光埋点 - 播放列表页面的曝光和收藏列表页面的曝光</span></span><br><span class="line"><span class="keyword">const</span> pageImpressLog = &#123;</span><br><span class="line">  page: <span class="string">'play_list'</span> or <span class="string">'collection_list'</span>,</span><br><span class="line">  type: <span class="string">'impress'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 音乐列表项的点击埋点 - 分别对两个页面的每个元素进行埋点</span></span><br><span class="line"><span class="keyword">const</span> itemClickLog = &#123;</span><br><span class="line">  page: <span class="string">'play_list'</span> or <span class="string">'collection_list'</span>,</span><br><span class="line">  type: <span class="string">'click'</span>,</span><br><span class="line">  id: <span class="string">'5486234'</span> <span class="comment">// 音乐的id</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>对于页面曝光埋点，我们可以直接在对应的页面上进行埋点。但是对于公共业务组件，埋点就显得比较繁琐：我们需要在通过props把page的信息传入到MusicList中，再由它传至MusicItem。这会带来两个问题：</p>
<ol>
<li>page信息实际上和MusicList / MusicItem 组件无关，这影响了组件的独立性。</li>
<li>当公共组件内有多层嵌套的时候，这个无关信息需要深入传递，增加了组件的复杂度。</li>
</ol>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>对于以上例子透露的问题，以及对需求进行分析，我们可以发现：</p>
<ol>
<li><p>页面曝光和音乐列表项点击的埋点存在公共字段（如：<code>page</code>），可以复用，且使用公共字段的两个组件存在逻辑上的嵌套关系。</p>
</li>
<li><p>公共组件可以使用props中的信息，对属于自己的特殊字段进行埋点（如：音乐列表项点击埋点中的<code>id</code>字段可以从通过<code>item.id</code>从props中提取）。</p>
</li>
<li><p>我们希望使用独立于props之外的独立数据流来提供埋点信息，降低埋点代码对业务代码的污染。</p>
</li>
</ol>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><ol>
<li>在祖先组件中注入和该组件相关的埋点信息</li>
<li>在后代组件中合并并使用所有祖先组件中注入的埋点信息</li>
</ol>
<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">////////// 组件 //////////</span><br><span class="line"></span><br><span class="line">// 音乐列表</span><br><span class="line">function MusicList(&#123;fetchList&#125;) &#123;</span><br><span class="line">	const [list, setList] = useState([])</span><br><span class="line">	useEffect(() =&gt; &#123;</span><br><span class="line">		fetchList.then(res =&gt; &#123;setList&#123;res&#125;&#125;)</span><br><span class="line">	&#125;, [])</span><br><span class="line">  </span><br><span class="line">  const musicItems = list.map(item =&gt; &lt;MusicItem key=&#123;item.id&#125; item=&#123;item&#125; /&gt;)</span><br><span class="line">  </span><br><span class="line">  return &lt;div&gt;&#123;musicItems&#125;&lt;/div&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 音乐列表项</span><br><span class="line">function MusicItem(&#123;item&#125;) &#123;</span><br><span class="line"><span class="addition">+  const log = useLog()</span></span><br><span class="line">  const onClick = () =&gt; &#123;</span><br><span class="line"><span class="addition">+   sendLog(&#123;</span></span><br><span class="line">			...log,</span><br><span class="line">			type: 'click',</span><br><span class="line">			id: item.id</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  return &lt;div &gt;&#123;item.name&#125;&lt;/div&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">////////// 页面 //////////</span><br><span class="line"></span><br><span class="line">// 播放列表页面</span><br><span class="line"><span class="addition">+ const PlayListPage = injectLog(&#123;</span></span><br><span class="line"><span class="addition">+  page: 'play_list'</span></span><br><span class="line"><span class="addition">+ &#125;)(</span></span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    const log = useLog()</span><br><span class="line">    useEffect(() =&gt; &#123;</span><br><span class="line">      sendLog(&#123;</span><br><span class="line">        ...log,</span><br><span class="line">        type: 'impress'</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;, [])</span><br><span class="line">  	return &lt;MusicList fetchList=&#123;fetchPlayList&#125; /&gt;</span><br><span class="line">	&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 收藏列表页面</span><br><span class="line">function CollectionListPage = injectLog(&#123;</span><br><span class="line">  page: 'collection_list'</span><br><span class="line">&#125;)(</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    const log = useLog()</span><br><span class="line">    useEffect(() =&gt; &#123;</span><br><span class="line">      sendLog(&#123;</span><br><span class="line">        ...log,</span><br><span class="line">        type: 'impress'</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;, [])</span><br><span class="line">    return &lt;MusicList fetchList=&#123;fetchCollectionList&#125; /&gt;</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>从高亮行可以看到这种解决方案的示例：</p>
<ol>
<li>在页面中使用<code>injectLog</code>注入公共埋点信息。</li>
<li>在埋点发送处使用<code>useLog</code>获取合并后的埋点信息，并发送。</li>
</ol>
<h4 id="一次失败的尝试"><a href="#一次失败的尝试" class="headerlink" title="一次失败的尝试"></a>一次失败的尝试</h4><p>由于react<a href="https://imkev.dev/react-rendering-order" target="_blank" rel="noopener">使用DFS进行渲染</a>，我的第一个想法是使用一个stack来存储所有祖先节点的渲染信息。<code>injectLog</code>HOC的简单版实现如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stack = []</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">injectLog</span>(<span class="params">log</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">Component</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">     	stack.push(log)</span><br><span class="line">    	<span class="keyword">const</span> component = React.createElement(Component, props)</span><br><span class="line">    	stack.pop(log)</span><br><span class="line">    	<span class="keyword">return</span> component </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这里执行stack pop操作的位置有问题。因为React.createElement并不会执行render函数。它返回的是一个Element，是一个所渲染的元素的描述，可以理解为一个plain object。React会通过render函数返回的描述自己控制渲染的执行。实际上，react profiler提供了onRender API。在render执行结束后会调用该回调函数。但是由于profiler会影响性能，官方不建议在生产环境使用。</p>
<h4 id="注入和读取"><a href="#注入和读取" class="headerlink" title="注入和读取"></a>注入和读取</h4><p>使用react context，独立与组件之外对埋点信息进行存储。通过provider和consumer实现了脱离props传参之外的数据流。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/08/interactive-animation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zile GUO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zile GUO">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/08/interactive-animation/" class="post-title-link" itemprop="url">使用react-use-gesture和react-spring的交互式动画</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-02-08 15:13:35" itemprop="dateCreated datePublished" datetime="2021-02-08T15:13:35+08:00">2021-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-24 15:15:43" itemprop="dateModified" datetime="2021-09-24T15:15:43+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/animation/" itemprop="url" rel="index"><span itemprop="name">animation</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/animation/interaction/" itemprop="url" rel="index"><span itemprop="name">interaction</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当页面中存在大量诸如页面拖动等动画时，手动处理手势事件，并将其绑定到诸如div等元素的属性将是一件费力且低效的工作。而<a href="https://github.com/pmndrs/react-use-gesture" target="_blank" rel="noopener">react-use-gesture</a>和<a href="https://github.com/pmndrs/react-spring" target="_blank" rel="noopener">react-spring</a>分别对<strong>手势</strong>和<strong>动画</strong>进行了抽象，为使用<strong>react hooks</strong>创建交互式动画提供了一种更为便捷的解决方案。</p>
<p>本文将会先简要介绍使用<a href="https://github.com/pmndrs/react-use-gesture" target="_blank" rel="noopener">react-use-gesture</a>和<a href="https://github.com/pmndrs/react-spring" target="_blank" rel="noopener">react-spring</a>创建交互式动画的方式，以及简要的实现解析。然后描述在开发过程中遇到的问题（兼容性问题&amp;接口问题）及其解决方案。</p>
<h2 id="react-use-gesture"><a href="#react-use-gesture" class="headerlink" title="react-use-gesture"></a>react-use-gesture</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>react-use-gesture</p>
<ol>
<li><p>对浏览器的用户输入事件进行了封装，提供了统一的手势接口，使复杂的手势（如：拖动，缩放）易于配置。</p>
</li>
<li><p>提供了原生事件所没有的属性（如：速度，距离），丰富了事件所包含的信息。</p>
</li>
</ol>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p><strong>例子</strong></p>
<p>一个典型的例子如下所示。使用手势hook中注册回调函数，回调函数负责处理事件并触发side effects。hook会返回一个bind函数，通过调用该函数，将其绑定到react节点上。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bind = useDrag(<span class="function"><span class="params">state</span> =&gt;</span> doSomethingWith(state), config)</span><br><span class="line"><span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> &#123;<span class="attr">...bind</span>(<span class="attr">arg</span>)&#125; /&gt;</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 其中：</p>
<ol>
<li>手势hook传入的第一个参数是回调函数，第二个参数是手势配置。</li>
<li>bind函数中传入参数的方式，常用于给多个节点绑定同一个回调函数，详见<a href="https://codesandbox.io/s/fh8r8?file=/src/index.js:1694-1698" target="_blank" rel="noopener">这个例子</a>。</li>
</ol>
</blockquote>
<p><strong>手势hook</strong></p>
<p>目前支持的有普通手势：<code>useDrag</code>，<code>useMove</code>，<code>useHover</code>，<code>useScroll</code>，<code>useWheel</code>，<code>usePinch</code>，以及复合手势：<code>useGesture</code>。详细功能见<a href="https://use-gesture.netlify.app/docs/hooks/" target="_blank" rel="noopener">列表</a>。</p>
<blockquote>
<p>需要区分：</p>
<ul>
<li><p>useDrag，useMove和useHover</p>
<p>drag事件只有在用户使用控制器（鼠标 / 触控屏）拖动（按压 / 触摸）时触发；而move事件会在控制器hover（onPointerMove）时即触发。而hover事件只处理控制器进入和离开事件（onPointerEnter &amp; onPointerLeave）</p>
</li>
<li><p>useWheel和useScroll</p>
<p>wheel事件只会被鼠标触发。scroll事件只有在元素真实发生滚动的时候才会触发；而鼠标在元素上滑动滚轮就可以触发wheel事件。</p>
</li>
</ul>
</blockquote>
<p><strong>手势配置</strong></p>
<p>比较常用的配置项有：domTarget / eventOptions，以及用于控制手势范围的 bounds / distanceBounds / angleBounds / rubberband，用于控制swipe的 swipeDistance / swipeVelocity / swipeDuration 等。详细内容可以在<a href="t.music.163.com/st-playlist-summerize/summerize/index.html">这里</a>找到。</p>
<blockquote>
<p>其中：</p>
<ul>
<li>domTarget用于替代bind函数，直接给dom ref绑定事件。当需要设置事件为<a href="https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener#improving_scrolling_performance_with_passive_listeners" target="_blank" rel="noopener">passive</a>来提升性能时，必须使用domTarget。</li>
</ul>
</blockquote>
<p><strong>事件</strong></p>
<p>recognizer会给事件回调传入丰富的事件信息，诸如：movement，offset，velocity等。详见<a href="https://use-gesture.netlify.app/docs/state/" target="_blank" rel="noopener">文档</a>。</p>
<blockquote>
<p>其中较为常用的几个属性为：</p>
<ul>
<li><p>movement和offset的区别</p>
<p>movement是单次拖动过程中手势拖动的向量，offset是在一个节点上所有手势拖动的向量和。</p>
</li>
<li><p>memo</p>
<p>用于记忆用户的自定义事件属性</p>
</li>
<li><p>cancel</p>
<p>取消当前事件</p>
</li>
<li><p>event</p>
<p>原始事件</p>
</li>
</ul>
</blockquote>
<p><strong>注意</strong></p>
<ol>
<li>为了避免和浏览器默认的拖动产生冲突（如：图片和链接的默认拖动行为），需要设置css：<code>touch-action: none</code>。同时，如需兼容firefox，还需要prevent default，详见<a href="https://use-gesture.netlify.app/docs/faq/#why-cant-i-properly-drag-an-image-or-a-link" target="_blank" rel="noopener">这里</a>。</li>
</ol>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p><strong>初始化</strong></p>
<ul>
<li>用户调用接口，传入handlers和config</li>
<li>实例化controller<ul>
<li>实例化接口对应的recognizer，将handlers传入recognizer</li>
<li>将recognizer需要注册的事件列表注册到dom</li>
</ul>
</li>
</ul>
<p><strong>回调</strong></p>
<ul>
<li>当recognizer监听到对应的手势时，触发handlers</li>
</ul>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><ul>
<li><p>Event delegation</p>
<p>在react-use-gesture提供了更加丰富的事件信息的同时，也增加了每次事件计算信息的性能消耗。通过事件代理对事件进行统一处理可以优化性能。</p>
</li>
</ul>
<h2 id="react-spring"><a href="#react-spring" class="headerlink" title="react-spring"></a>react-spring</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><p>react spring提供了基于弹簧物理模拟的动画。它基于弹簧模型而不是常见的曲线 / 时长模型（尽管API中也支持指定动画时长），使其的动画效果更为自然。因为基于物理模型的动画将是<strong>连贯</strong>且更具<strong>交互性</strong>的。</p>
<blockquote>
<p>Andy Matuschak (ex Apple UI-Kit developer) <a href="https://twitter.com/andy_matuschak/status/566736015188963328" target="_blank" rel="noopener">expressed it once</a>: <em>Animation APIs parameterized by duration and curve are fundamentally opposed to continuous, fluid interactivity</em>.</p>
</blockquote>
<h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p><strong>例子</strong></p>
<p>React-spring的使用主要分为三步：</p>
<ol>
<li>使用动画hook配置动画并获得返回的style属性和set函数</li>
<li>将style属性传入animated组件</li>
<li>使用set函数更新动画</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;useSpring, animated&#125; <span class="keyword">from</span> <span class="string">'react-spring'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [style, <span class="keyword">set</span>] = useSpring(() =&gt; (&#123;opacity: <span class="number">1</span>, <span class="attr">from</span>: &#123;<span class="attr">opacity</span>: <span class="number">0</span>&#125;&#125;))</span><br><span class="line">  <span class="comment">// ... use set to update style</span></span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">animated.div</span> <span class="attr">style</span>=<span class="string">&#123;style&#125;</span>&gt;</span>I will fade in<span class="tag">&lt;/<span class="name">animated.div</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：</p>
<ol>
<li>set函数并不是直接设置style，而是提供了一个目标，而useSpring会自己计算出下一帧该如何变化以接近目标。</li>
<li>App函数并不会在set之后重新执行，因为style实际上是mutable的。</li>
<li><a href="https://www.react-spring.io/docs/hooks/use-spring#either-overwrite-values-to-change-the-animation:~:text=Either%3A%20overwrite%20values%20to%20change%20the%20animation" target="_blank" rel="noopener">另外一种更新动画的方式</a>是在useSpring中直接传入新的值，但例子中使用的方法性能更优。</li>
</ol>
</blockquote>
<p><strong>动画hook</strong></p>
<table>
<thead>
<tr>
<th>hook</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>useSpring</td>
<td>动画化传入的参数</td>
</tr>
<tr>
<td>useSprings</td>
<td>创建多个动画，使用各自的动画配置，用于静态列表</td>
</tr>
<tr>
<td>useTrail</td>
<td>创建多个动画，使用同一个配置，每一个动画将会跟随前一个动画</td>
</tr>
<tr>
<td>useTransition</td>
<td>组件出现和消失的动画</td>
</tr>
<tr>
<td>useChain</td>
<td>串联动画，下一个动画会在上一个结束后开始</td>
</tr>
</tbody></table>
<blockquote>
<p>除了hook之外，react-spring还提供了动画组件，如：Spring，Trail等。参数与hook相似，这里不再赘述。</p>
</blockquote>
<p><strong>动画属性</strong></p>
<ul>
<li><p>字段类型（number + string）</p>
<p>reat-spring不仅仅支持例子中的数字类型的动画，也支持字符串类型（如：transform，color）的动画。详见<a href="https://www.react-spring.io/docs/hooks/basics#up-front-interpolation:~:text=Up%2Dfront%20interpolation" target="_blank" rel="noopener">Up-front interpolation</a>。</p>
</li>
<li><p>插值（interpolate）</p>
<p>同时，react-spring也支持使用<a href="https://www.react-spring.io/docs/hooks/api#interpolations:~:text=Interpolations" target="_blank" rel="noopener">插值函数</a>将一个更新后的数值映射到真实的动画属性。它允许用户<strong>重复使用</strong>一个计算结果，将其应用到多个动画属性上，提高了<strong>性能</strong>。一个例子可以在<a href="https://www.react-spring.io/docs/hooks/basics#view-interpolation:~:text=View%20interpolation,-In" target="_blank" rel="noopener">这里</a>找到。</p>
</li>
</ul>
<p><strong>更新动画</strong></p>
<p>使用hook返回的set函数更新目标，参数同hook参数一致。见<a href="https://www.react-spring.io/docs/hooks/api#properties:~:text=Properties,100%2C%20onRest%3A%20()%20%3D%3E%20...%20%7D" target="_blank" rel="noopener">properties</a>。</p>
<ul>
<li><p>from / to …</p>
</li>
<li><p><a href="https://www.react-spring.io/docs/hooks/api#configs:~:text=Configs" target="_blank" rel="noopener">config</a></p>
<p>通过 mass / tension / friction 设置基于物理模拟的动画，或使用duration来设置基于时长的动画。</p>
<p>或者可以使用config.default / config.slow … 等预设动画。</p>
</li>
</ul>
<h3 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h3><ul>
<li><p>style：通过将css属性与动画组件直接绑定，跳过了业务组件的重新渲染，提高性能。</p>
<p><strong>监听动画属性</strong>：React-spring的hooks返回的style属性并不是简单的<code>CSSProperties</code>类型的数据，而是<code>SpringValues</code>类型。其中每个<code>SpringValue</code>通过<a href="https://www.npmjs.com/package/fluids" target="_blank" rel="noopener">fluids</a>库的<code>addFluidObserver</code>函数监测变化。实现类似mobx中observable的效果。当style被传入animated组件时，<code>getAnimatedState</code>函数会提取props中的fluidValue并添加到依赖集中，并为每个依赖通过<code>addFluidObserver</code>监听变化。</p>
<p><strong>更新</strong>：当<code>SpringValue</code>更新时，会被加入一个<code>Set</code>。在每个动画帧（使用<code>rafz</code>库的<code>onFrame</code>函数，调用requestAnimationFrame）的最后，这些更新会被读取并通过<code>flushCalls</code>函数应用到组件上。</p>
</li>
</ul>
<h2 id="兼容性问题"><a href="#兼容性问题" class="headerlink" title="兼容性问题"></a>兼容性问题</h2><h3 id="Pointer-event"><a href="#Pointer-event" class="headerlink" title="Pointer event"></a>Pointer event</h3><p><strong>问题</strong></p>
<p>由于react-use-spring使用了<a href="https://developer.mozilla.org/en-US/docs/Web/API/PointerEvent" target="_blank" rel="noopener">pointer event</a>，导致在低版本的浏览器中将无法使用。</p>
<p><strong>解决方案</strong></p>
<p>所幸<a href="https://github.com/jquery/PEP" target="_blank" rel="noopener">pepjs</a>提供了pointer event的polyfill方案，而其使用方式也十分简单：</p>
<ol>
<li><p>安装pepjs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pepjs</span><br></pre></td></tr></table></figure>
</li>
<li><p>在代码中引入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'pepjs'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在对应的节点设置touch-action属性（浏览器为了优化性能，不指定touch-action默认不触发事件）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">'test'</span> <span class="attr">touch-action</span>=<span class="string">"none"</span>&gt;</span>Test button!<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注册事件</p>
<ul>
<li><p>react</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export function Pointable() &#123;</span><br><span class="line">  return &lt;div touch-action&#x3D;&quot;none&quot; onPointerDown&#x3D;&#123;(e) &#x3D;&gt; console.log(e)&#125; &#x2F;&gt; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>DOM</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.getElementById(&quot;test&quot;).addEventListener(&quot;pointerdown&quot;, function(e) &#123;console.log(e)&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<p>注意：在使用pepjs时，当用户的触摸操作需要用到浏览器默认的行为（如：scroll）时，同样需要指定touch-action（如：touch-action=’auto’）。</p>
<h3 id="IOS-13-0-amp-13-1"><a href="#IOS-13-0-amp-13-1" class="headerlink" title="IOS 13.0 &amp; 13.1"></a>IOS 13.0 &amp; 13.1</h3><p><strong>问题</strong></p>
<p>在IOS13.x及之后的版本中，移动端的safari&amp;chrome开始支持pointer event。但是对于13.0 &amp; 13.1，官方对于pointer event的实现（pointerevent.buttons的值）仍然有问题，见<a href="https://caniuse.com/pointer" target="_blank" rel="noopener">can i use</a>。在这两个版本中，由于：</p>
<ol>
<li>pepjs不再polyfill</li>
<li>react-use-gesture的实现依赖于pointerevent.buttons的值</li>
</ol>
<p>造成了在13.0 &amp; 13.1产生了一个pointerevent.buttons polyfill的真空地带，导致react-use-gesture失效。这个问题在<a href="https://github.com/pmndrs/react-use-gesture/issues/103#issuecomment-545422374" target="_blank" rel="noopener">issue</a>中也有描述。</p>
<p><strong>解决方案</strong></p>
<p>因为这是pointer event实现的bug，react-use-gesture并不准备通过为这两个版本修改代码。因此我们需要自己fork一个react-use-gesture:</p>
<p>路径：<code>./src/recognizers/DragRecognizer.ts</code></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">onDragChange = (event: PointerEvent): void =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    // If the event doesn't have any button / touches left we should cancel</span><br><span class="line">    // the gesture. This may happen if the drag release happens outside the browser</span><br><span class="line">    // window.</span><br><span class="line"><span class="deletion">-   if (!genericEventData.down) &#123;</span></span><br><span class="line"><span class="addition">+   if (!is_ios_13_0_or_13_1() &amp;&amp; !genericEventData.down) &#123;</span></span><br><span class="line">      this.onDragEnd(event)</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong></p>
<p>修改后的库会有一个问题，即：使用鼠标拖动移出浏览器窗口后释放鼠标，再移入时，在IOS13.0和IOS13.1中，将继续处于拖动状态。</p>
<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><h3 id="react-spring-v9-资源汇总"><a href="#react-spring-v9-资源汇总" class="headerlink" title="react-spring v9 资源汇总"></a>react-spring v9 资源汇总</h3><p>React-spring目前（2021/02/07）最新的稳定版本是8.0.27，最新的release candidate是9.0.0-rc.3。但是由于官网的文档仍然是v8的版本，且我们在使用v9时遇到了很多奇怪的问题，并不建议使用v9。</p>
<p>如果你仍然想要使用v9，以下是一些文档的链接：</p>
<ul>
<li><a href="https://aleclarson.github.io/react-spring/v9/" target="_blank" rel="noopener">v9新特性</a></li>
<li><a href="https://aleclarson.github.io/react-spring/v9/breaking-changes/" target="_blank" rel="noopener">v9 useTransition的新API</a></li>
</ul>
<h3 id="react-spring-v9-常见问题及解决方式"><a href="#react-spring-v9-常见问题及解决方式" class="headerlink" title="react-spring v9 常见问题及解决方式"></a>react-spring v9 常见问题及解决方式</h3><ul>
<li><p>Q：在开发环境无问题，部署环境出现TypeError（如： <code>Uncaught TypeError: r.willAdvance is not a function</code>）</p>
<p>A：因为v9 - rc.3在package.json中声明了<code>sideEffect: ture</code>。webpack时会进行剪枝（tree shaking）操作，导致报错（官方表示会在rc.4修复）。<a href="https://github.com/pmndrs/react-spring/issues/1078#issuecomment-753032426" target="_blank" rel="noopener">修复方法</a>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "react-spring-issue-1078": "find node_modules -path \\*@react-spring/\\*/package.json -exec sed -i.bak 's/\"sideEffects\": false/\"sideEffects\": true/g' &#123;&#125; +",</span><br><span class="line">    "postinstall": "npm run react-spring-issue-1078",</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Q：useTransition / Transition 中各种不符合预期的表现</p>
<p>A：首先检查是否使用了<a href="https://aleclarson.github.io/react-spring/v9/breaking-changes/#The-useTransition-hook" target="_blank" rel="noopener">v9新的API格式</a>。然后尝试在items参数中传入数组而不是其他类型。尽管在<a href="https://www.react-spring.io/docs/hooks/use-transition" target="_blank" rel="noopener">文档</a>的示例中有很多非数组的例子，但这些都不是标准的使用方法，在v9中可能导致各种预期之外的动画效果。</p>
</li>
<li><p>Q：useTransition / Transition 中的 Multi-stage transitions 的stage数量和设定不符</p>
<p>A：检查是否两个阶段设定的状态没有变化，如：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">leave=&#123;[</span><br><span class="line">	&#123;<span class="attr">opacity</span>: <span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">opacity</span>: <span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">opacity</span>: <span class="number">0</span>&#125;,</span><br><span class="line">]&#125;</span><br></pre></td></tr></table></figure>

<p>上图的设定会导致中间的stage被无视，实际效果不是<code>opacity: 1-&gt;1-&gt;0</code>，而是<code>opacity: 1-&gt;0</code>。一个备用方案是设定用户无法感知的变化，如：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">leave=&#123;[</span><br><span class="line">  &#123;<span class="attr">opacity</span>: <span class="number">1</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">opacity</span>: <span class="number">0.99</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">opacity</span>: <span class="number">0</span>&#125;,</span><br><span class="line">]&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/18/animated-react-native/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zile GUO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zile GUO">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/18/animated-react-native/" class="post-title-link" itemprop="url">Animated in React Native</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-18 21:57:39" itemprop="dateCreated datePublished" datetime="2020-10-18T21:57:39+08:00">2020-10-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-24 15:05:07" itemprop="dateModified" datetime="2021-09-24T15:05:07+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/react-native/" itemprop="url" rel="index"><span itemprop="name">react native</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>在学习React Native动画的时候，看到了这段<a href="https://zhuanlan.zhihu.com/p/103293495" target="_blank" rel="noopener">使用Animated的基础代码</a>。可以看到这段代码并不使用<code>setState</code>来更新状态以实现动画效果。在本文中，笔者将会总结博客和源码中的相关资料，以期了解这段代码的实现原理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FadeInView = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> fadeAnim = useRef(<span class="keyword">new</span> Animated.Value(<span class="number">0</span>)).current  <span class="comment">// 透明度初始值设为0</span></span><br><span class="line"></span><br><span class="line">  React.useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    Animated.timing(                  <span class="comment">// 随时间变化而执行动画</span></span><br><span class="line">      fadeAnim,                       <span class="comment">// 动画中的变量值</span></span><br><span class="line">      &#123;</span><br><span class="line">        toValue: <span class="number">1</span>,                   <span class="comment">// 透明度最终变为1，即完全不透明</span></span><br><span class="line">        duration: <span class="number">10000</span>,              <span class="comment">// 让动画持续一段时间</span></span><br><span class="line">      &#125;</span><br><span class="line">    ).start()                      <span class="comment">// 开始执行动画</span></span><br><span class="line">  &#125;, [fadeAnim])</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Animated.View                 <span class="comment">// 使用专门的可动画化的View组件</span></span><br><span class="line">      style=&#123;&#123;</span><br><span class="line">        ...props.style,</span><br><span class="line">        opacity: fadeAnim,         <span class="comment">// 将透明度绑定到动画变量值</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;props.children&#125;</span><br><span class="line">    &lt;<span class="regexp">/Animated.View&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Do-Work-in-JS-Native-Driver-Animations"><a href="#Do-Work-in-JS-Native-Driver-Animations" class="headerlink" title="Do Work in JS || Native Driver Animations"></a>Do Work in JS || Native Driver Animations</h2><p>在<a href="https://www.freecodecamp.org/news/how-react-native-animations-work/" target="_blank" rel="noopener">这篇文章</a>里提到了Animated的两种计算动画的方式和对应的优劣。</p>
<ol>
<li>在JS线程中使用<code>requestAnimationFrame</code>计算动画参数，并使用Bridge将数据传输给原生代码</li>
<li>在动画开始前通过Bridge直接将动画信息传输给原生代码，由UI线程来计算动画参数</li>
</ol>
<p>可以看到使用<a href="https://ui.dev/imperative-vs-declarative-programming/" target="_blank" rel="noopener">声明式的代码</a>的方式定义动画便于使用UI线程来提高性能。<br>同时，不论是1还是2，都是由UI线程来渲染原生视图，因此可以跳过频繁的<code>setState</code>和<code>render</code>来提高性能。</p>
<h2 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h2><h3 id="Animated-Value"><a href="#Animated-Value" class="headerlink" title="Animated.Value"></a>Animated.Value</h3><p>在<a href="https://github.com/facebook/react-native" target="_blank" rel="noopener">react-native库</a>的<code>Libraries/Animated/nodes/AnimatedValue.js</code>文件中描述了Animated.Value是如何工作的：<br>Animated构建了一个依赖的有向无环图。view属性的计算包含了两个阶段：</p>
<ol>
<li>Top Down Phase<br>当Animated.Value被更新的时候，它会寻找并标记叶节点：即需要更新的view</li>
<li>Bottom Up Phase<br>从被标记的叶节点回溯，以此得到它所需的value。（这么做的原因是某些view的属性可能是由多个value组合而成，如：transform）</li>
</ol>
<h3 id="Animated-Component"><a href="#Animated-Component" class="headerlink" title="Animated.[Component]"></a>Animated.[Component]</h3><p>在<code>Libraries\Animated\createAnimatedComponent.js</code>文件中，可以看到在mount/update的时候，使用<code>this._propsAnimated.setNativeView</code>为AnimatedProps绑定了component。同时在<code>Libraries\Animated\nodes\AnimatedProps.js</code>文件中，使用<code>__connectAnimatedView</code>函数通过native tag标识将动画节点与对应的native view相连。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/16/data-validation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zile GUO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zile GUO">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/16/data-validation/" class="post-title-link" itemprop="url">Data Validation with Typescript</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-16 22:04:29" itemprop="dateCreated datePublished" datetime="2020-09-16T22:04:29+08:00">2020-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-24 14:57:06" itemprop="dateModified" datetime="2021-09-24T14:57:06+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/backend/" itemprop="url" rel="index"><span itemprop="name">backend</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>To build backend API, one of the problem is validate the external data. Because the incoming data is not necessary valid. The invalid data might come from user input, wrong call of API in frontend. It might also come from malicious attackers. Thus, validation in backend is neccessary no matter frontend did it or not.</p>
<p>Since I’m using Typescript to build backend in <a href="https://github.com/zlguo1996/Todo" target="_blank" rel="noopener">Todo project</a>, it would reduce the redundancy of code if I can make use of existing type definition in type definition. <a href="https://2ality.com/2020/06/validating-data-typescript.html#approaches-for-data-validation-in-typescript" target="_blank" rel="noopener">This post</a> introduces several approaches for data validation categorized by using JSON schema or not. In my project, I tried the approach that converting Typescript types to JSON schema.</p>
<h2 id="Packages"><a href="#Packages" class="headerlink" title="Packages"></a>Packages</h2><ul>
<li><a href="https://github.com/YousefED/typescript-json-schema" target="_blank" rel="noopener">typescript-json-schema</a>: Generate json-schemas from Typescript sources.</li>
<li><a href="https://ajv.js.org/" target="_blank" rel="noopener">ajv</a>: JSON schema validator</li>
</ul>
<h2 id="Approach"><a href="#Approach" class="headerlink" title="Approach"></a>Approach</h2><ol>
<li>Use <code>typescript-json-schema</code> to pre-compile existing type to JSON schema.</li>
<li>Use <code>ajv</code> to make use of the schema from <code>1</code> to validate the request data.</li>
</ol>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><ol>
<li>Typescript to JSON schema<br> In my project, I store types used in Web API in <a href="https://github.com/zlguo1996/Todo/tree/master/services/common" target="_blank" rel="noopener">common folder</a> to use them both in frontend code and backend code.<br> After write validation types in <code>src/apiTypes</code>, the following command in <code>package.json</code> is used to convert typescript to JSON schema file. (use <code>install</code> command name because it would be called after <code>npm install</code>. Please refer to <a href="https://docs.npmjs.com/misc/scripts" target="_blank" rel="noopener">lifecycle scripts</a>) <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "install": "typescript-json-schema src/apiTypes.ts * --noExtraProps --out src/schema.json"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
 The <strong>benefit</strong> of <code>typescript-json-schema</code> is that it allows using annotations to enhance the typescript properties in convertion. Like the following: <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> interface TodoItem &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@minLength </span>0</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@maxLength </span>100</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    text: string,</span><br><span class="line">    state: TodoItemState,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>Validation with JSON schema<br>After export JSON schema object from <code>common</code>, we can use it with <code>ajv</code>:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ajv = <span class="keyword">new</span> Ajv(&#123;</span><br><span class="line">     schemaId: <span class="string">'auto'</span>,</span><br><span class="line">     allErrors: <span class="literal">true</span>,</span><br><span class="line"> &#125;)</span><br><span class="line"> ajv.addSchema(itemSchema, <span class="string">'item'</span>)</span><br></pre></td></tr></table></figure>
Then, the data could be validated like this:<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> validator = ajv.getSchema(<span class="string">'item#/definitions/AddItem'</span>)</span><br><span class="line"><span class="keyword">const</span> result = validator(data)</span><br></pre></td></tr></table></figure>
For details in the URI parameter of <code>ajv.getSchema</code> function, please refer to the <a href="https://json-schema.org/understanding-json-schema/structuring.html" target="_blank" rel="noopener">structuring complex schema</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/16/merge-data/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zile GUO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zile GUO">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/16/merge-data/" class="post-title-link" itemprop="url">Shared Contents Store - Merge Data with No Web Server</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-16 11:25:59" itemprop="dateCreated datePublished" datetime="2020-07-16T11:25:59+08:00">2020-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-24 14:57:06" itemprop="dateModified" datetime="2021-09-24T14:57:06+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Work in progress…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/15/react-performance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zile GUO">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zile GUO">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/15/react-performance/" class="post-title-link" itemprop="url">Participants Store - React Performance Optimization Practice</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-07-15 20:23:50" itemprop="dateCreated datePublished" datetime="2020-07-15T20:23:50+08:00">2020-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-09-24 14:57:06" itemprop="dateModified" datetime="2021-09-24T14:57:06+08:00">2021-09-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/" itemprop="url" rel="index"><span itemprop="name">code</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/code/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>In our <a href="https://github.com/JitsiPartyTeam/jitsi-party" target="_blank" rel="noopener">jitsi-party project</a>, participants store have nested data structure for UI to render. For example,  <code>pariticpants - some participant - pose - position</code>. In <a href="https://github.com/hasevr/jitsi-party" target="_blank" rel="noopener">prototype 1</a>, We’ve found that naive way of updating UI would cause lag after user interaction (like change local participant position with keyboard). For more fluent interaction, the following are our tries to optimize the performance of React.</p>
<h2 id="1-Avoid-using-props-for-message-passing"><a href="#1-Avoid-using-props-for-message-passing" class="headerlink" title="1. Avoid using props for message passing"></a>1. Avoid using props for message passing</h2><h3 id="Theory"><a href="#Theory" class="headerlink" title="Theory"></a>Theory</h3><p>In <a href="https://medium.com/@alexandereardon/performance-optimisations-for-react-applications-b453c597b191" target="_blank" rel="noopener">round 1</a> and <a href="https://medium.com/@alexandereardon/performance-optimisations-for-react-applications-round-2-2042e5c9af97" target="_blank" rel="noopener">round 2</a>, author have introduced ways to improve performance.</p>
<p>He proposed to use：</p>
<ol>
<li><p>use <code>shouldComponentUpdate</code> to avoid re-render on sibling nodes.</p>
</li>
<li><p>connected components to update specific node on virtual DOM directly. That avoids costs on reconciliation &amp; render on its ancestor nodes.</p>
</li>
</ol>
<h3 id="Practice"><a href="#Practice" class="headerlink" title="Practice"></a>Practice</h3><p>In storybook, <code>store-participants</code> demonstrate how we put that idea into practice. (MobX + React Hooks)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> participants = &#123;</span><br><span class="line">    particpant_0: &#123;</span><br><span class="line">        pose: &#123;</span><br><span class="line">            position: [<span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            orientation: <span class="number">0</span></span><br><span class="line">        &#125;,</span><br><span class="line">        information: &#123;</span><br><span class="line">            name: <span class="string">'name'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">    participant_N: &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We want to render participants list into UI. If we change only one participants’ position, let’s see how it would works:</p>
<ol>
<li><p>If we use props to pass the change from root node, a lot of computation time would be wasted on reconciling and rendering the data that did not change:</p>
<img src="/2020/07/15/react-performance/RenderPerformance3.png" class="" title="Render Performance 3">
</li>
<li><p>To avoid re-rendering on sibling nodes (yellow ones on the upper image), we can use <code>useMemo</code> hook to remember the participant node. Only re-render it  when the id of participant have changed (add / delete).</p>
 <img src="/2020/07/15/react-performance/RenderPerformance2.png" class="" title="Render Performance 2">
</li>
<li><p>If we connect every participant directly to the store (connect to MobX using <code>useContext</code> hook), parent nodes would not be reconciliated.</p>
<img src="/2020/07/15/react-performance/RenderPerformance1.png" class="" title="Render Performance 1">

</li>
</ol>
<h2 id="2-Batch-state-updates"><a href="#2-Batch-state-updates" class="headerlink" title="2. Batch state updates"></a>2. Batch state updates</h2><h3 id="Practice-1"><a href="#Practice-1" class="headerlink" title="Practice"></a>Practice</h3><h4 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h4><p>In map, we allow user to transform 2 things: 1. the pose of map itself, 2. pose of local participant relative to the map.  That means we have 2 coordinates: 1. screen coordinate, what mouse use, 2. map coordinate, what local participant use.</p>
<p>For a point P, $P_{ScreenCoordinate} = M * P_{MapCoordinate}$, where $M$ is transform matrix of map coordinate to screen coordinate.</p>
<p>So,</p>
<ul>
<li>In <code>Map</code> component, we would update $M$ when user drag the map.</li>
<li>In every <code>Participant</code> component, we would have to refer to $M$ when user drag the participant, to convert mouse position from screen coordinate to map coordinate. Then we could update the position of dragged participant.</li>
</ul>
<p>The problem is, since we use context to pass $M$ to <code>Participant</code>, every time we drag <code>Map</code>, every <code>Participant</code> would have to update because $M$ changed.</p>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><p>To avoid updating <code>Participant</code> when only <code>Map</code> is dragged with the assumption: only <strong>one component</strong> would be dragged at the one time.</p>
<p>With above assumption, we could hide the change on $M$ to <code>Participant</code> when <code>Map</code> is being dragged. Only when drag gesture is ended, we commit the final $M$ to a new state $CommitedM$, and pass $CommitedM$ to <code>Participant</code>.</p>
<h2 id="3-Using-dynamic-CSS"><a href="#3-Using-dynamic-CSS" class="headerlink" title="3. Using dynamic CSS"></a>3. Using dynamic CSS</h2><h3 id="Theory-1"><a href="#Theory-1" class="headerlink" title="Theory"></a>Theory</h3><p>Calling <code>render</code> is not the only way to update styles.</p>
<h3 id="Practice-2"><a href="#Practice-2" class="headerlink" title="Practice"></a>Practice</h3><h4 id="Problem-1"><a href="#Problem-1" class="headerlink" title="Problem"></a>Problem</h4><p>In <code>Map</code> component, we allow user to rotate their map. However, user would not willing to see their video avatars also being rotated. Thus, we have to counter rotate those avatars.</p>
<p>The most simple way is to pass down the transform matrix $M$ down to every <code>Participant</code>. However, that would cause every <code>Participant</code> component render function being re-executed when user change <code>Map</code> rotation.</p>
<h4 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h4><p>A better way is to create a same CSS class for all <code>Participant</code>s. In that class we update the transform to the counter rotation of current $M$. Then we pass the class name to all participants.</p>
<p>Since the class name would not change. React would not re-render those <code>Participant</code>s when rotating <code>Map</code>. CSS would automatically apply new styles to them.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://medium.com/@alexandereardon/dragging-react-performance-forward-688b30d40a33" target="_blank" rel="noopener">Dragging React Performance Forward</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zile GUO</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">8</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zile GUO</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
